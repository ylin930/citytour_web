<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Place Choice Task</title>
        <link rel="stylesheet" href="styles.css" />
        <style>
            .choice-grid {
                display: grid;
                grid-template-columns: repeat(3, minmax(240px, 1fr));
                gap: 16px;
            }
            .choice {
                display: flex;
                flex-direction: column;
                border-radius: 14px;
                border: 2px solid transparent;
                background: #fff;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
                overflow: hidden;
            }
            .media-wrap {
                position: relative;
                width: 100%;
                height: 260px;
                background: #000;
                overflow: hidden;
            }
            .label {
                text-align: center;
                padding: 10px 8px;
                font-weight: 600;
            }
            .choice.disabled {
                filter: grayscale(100%);
                opacity: 0.55;
                pointer-events: none;
            }
            .choice.playing {
                border-color: #a3bffa;
                opacity: 1;
            }
            .choice.ready {
                filter: none;
                opacity: 1;
                pointer-events: auto;
            }
            .choice.selected {
                border-color: #2563eb;
                box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
            }
            .seqbar {
                display: flex;
                align-items: center;
                gap: 10px;
                margin: 6px 0 14px;
            }
            .seq-dot {
                width: 38px;
                height: 38px;
                border-radius: 10px;
                border: 2px dashed #bbb;
                display: grid;
                place-items: center;
                color: #777;
                font-weight: 700;
            }
            .seq-dot.active {
                border-style: solid;
                border-color: #2563eb;
                color: #2563eb;
            }
            .seq-dot.done {
                border-style: solid;
                border-color: #16a34a;
                background: #eafff2;
                color: #0f5132;
            }
        </style>
    </head>
    <body data-task="pc">
        <main class="container">
            <header class="header">
                <div>
                    <div class="badge" id="badge">PC</div>
                    <div class="h1">Pick the matching animation</div>
                    <div class="sub">Watch each option left → middle → right, then choose.</div>
                </div>
            </header>

            <section class="grid">
                <div class="card" style="display: flex; flex-direction: column; gap: 14px">
                    <div id="seqbar" class="seqbar"></div>
                    <div id="trialCounter" class="muted">Trial 1</div>
                    <div id="choices" class="choice-grid"></div>
                    <div style="display: flex; justify-content: flex-end; gap: 10px">
                        <!-- Back removed -->
                        <button id="submitBtn" class="btn primary" disabled>Submit</button>
                        <button id="nextBtn" class="btn" disabled>Next</button>
                    </div>
                    <div id="feedback" class="muted"></div>
                </div>
            </section>
        </main>

        <script type="module">
            /* ---------- Params / paths ---------- */
            const qs = new URLSearchParams(location.search);

            function canonCity(v) {
                const s = String(v ?? "City0").trim();
                const m = s.match(/(\d+)/);
                return `City${m ? parseInt(m[1], 10) : 0}`;
            }
            function canonSession(v) {
                const s = String(v ?? "0").trim();
                const m = s.match(/(\d+)/);
                return `${m ? parseInt(m[1], 10) : 0}`;
            }

            const TASK = "pc"; // force PC
            const rawCity = qs.get("city");
            const session = canonSession(qs.get("session")); // "0".."3"
            const sessionNum = parseInt(session, 10) || 0;
            let city = rawCity ? canonCity(rawCity) : `City${sessionNum}`;
            // If caller mistakenly passes City0 for S1–S3, correct it.
            if (sessionNum > 0 && city === "City0") city = `City${sessionNum}`;

            const v = String(qs.get("v") || "1");
            const lang = (localStorage.getItem("ct_language") || "EN").toLowerCase();

            // Config path
            const trialsURL = qs.get("trials") || `config/trials_${session}_${city}_${TASK}_v${v}.json`;
            const nextURL = qs.get("next") || `session_video.html?session=${encodeURIComponent(session)}`;

            // Instruction audio: pc_first (trial1), pc_next (others)
            const legacyCity0 = city === "City0"; // if your City0 is under /instructions/
            const instrFirst = (c) =>
                legacyCity0
                    ? `media/${c}/audio/${lang}/instructions/pc_first.mp3`
                    : `media/${c}/audio/${lang}/instructions/pc_first.mp3`; // same path for all if you've moved them
            const instrNext = (c) =>
                legacyCity0
                    ? `media/${c}/audio/${lang}/instructions/pc_next.mp3`
                    : `media/${c}/audio/${lang}/instructions/pc_next.mp3`;

            // Feedback only for practice (City0/Session0)
            const isPractice = sessionNum === 0 || city === "City0";

            // ---------- State / DOM ----------
            const grid = document.getElementById("choices");
            const trialCounter = document.getElementById("trialCounter");
            const submitBtn = document.getElementById("submitBtn");
            const nextBtn = document.getElementById("nextBtn");
            const feedback = document.getElementById("feedback");
            const seqbar = document.getElementById("seqbar");
            document.getElementById("badge").textContent = `PC • ${city} • S${session} v${v}`;

            let TRIALS = [];
            let idx = 0,
                selected = null,
                sequenceDone = false;
            let audioUnlocked = false;
            let currentInstr = null,
                currentPlaying = null;

            const setDisabled = (el) => {
                el.classList.remove("playing", "ready");
                el.classList.add("disabled");
            };
            const setPlaying = (el) => {
                el.classList.remove("disabled", "ready");
                el.classList.add("playing");
            };
            const setReady = (el) => {
                el.classList.remove("disabled", "playing");
                el.classList.add("ready");
            };

            function renderSeqBar() {
                seqbar.innerHTML = "";
                for (let i = 0; i < TRIALS.length; i++) {
                    const dot = document.createElement("div");
                    dot.className = "seq-dot" + (i === idx ? " active" : i < idx ? " done" : "");
                    dot.textContent = i + 1;
                    seqbar.appendChild(dot);
                }
            }

            function buildChoice(position, videoUrl) {
                const card = document.createElement("div");
                card.className = "choice disabled";
                const wrap = document.createElement("div");
                wrap.className = "media-wrap";
                const vid = document.createElement("video");
                vid.playsInline = true;
                vid.preload = "auto";
                vid.muted = !audioUnlocked;
                vid.style.width = "100%";
                vid.style.height = "100%";
                vid.style.objectFit = "cover";
                const src = document.createElement("source");
                src.src = videoUrl; // already full path from JSON
                src.type = "video/mp4";
                vid.appendChild(src);
                wrap.appendChild(vid);
                const label = document.createElement("div");
                label.className = "label";
                label.textContent = `Option ${position}`;
                card.append(wrap, label);

                card.addEventListener("click", () => {
                    if (!sequenceDone) return;
                    document.querySelectorAll(".choice").forEach((el) => el.classList.remove("selected"));
                    card.classList.add("selected");
                    selected = position;
                    submitBtn.disabled = false;
                });

                return { card, vid };
            }

            // Single “autoplay with fallback prompt”
            function playAudioAuto(url, { promptId, promptText = "▶ Play instruction" } = {}, onEnd) {
                let bar;
                const removeBar = () => {
                    if (bar) bar.remove();
                };
                const a = new Audio(url);
                a.preload = "auto";
                a.muted = false;
                a.volume = 1;

                a.addEventListener(
                    "play",
                    () => {
                        audioUnlocked = true;
                        removeBar();
                    },
                    { once: true }
                );
                a.addEventListener(
                    "ended",
                    () => {
                        removeBar();
                        onEnd && onEnd();
                    },
                    { once: true }
                );
                a.addEventListener(
                    "error",
                    () => {
                        removeBar();
                        onEnd && onEnd();
                    },
                    { once: true }
                );

                a.play().catch(() => {
                    bar = document.createElement("div");
                    bar.id = promptId;
                    bar.style.margin = "6px 0 8px";
                    bar.innerHTML = `<button class="btn" type="button">${promptText}</button>`;
                    seqbar.parentNode.insertBefore(bar, seqbar.nextSibling);
                    bar.querySelector("button").addEventListener(
                        "click",
                        () => {
                            a.currentTime = 0;
                            a.play()
                                .then(removeBar)
                                .catch(() => {
                                    removeBar();
                                    onEnd && onEnd();
                                });
                        },
                        { once: true }
                    );
                });
                return a;
            }

            function playOne(holder, onEnd) {
                const vEl = holder.vid;
                vEl.muted = !audioUnlocked;
                try {
                    vEl.currentTime = 0;
                } catch {}
                vEl.load();
                setPlaying(holder.card);
                currentPlaying = vEl;
                const start = () => vEl.paused && vEl.play().catch(() => {});
                vEl.addEventListener("canplay", start, { once: true });
                vEl.addEventListener(
                    "ended",
                    () => {
                        setReady(holder.card);
                        currentPlaying = null;
                        onEnd && onEnd();
                    },
                    { once: true }
                );
                vEl.addEventListener(
                    "error",
                    () => {
                        setReady(holder.card);
                        currentPlaying = null;
                        onEnd && onEnd();
                    },
                    { once: true }
                );
                start();
            }

            function startInstructionThenSequence(mediaCity, c1, c2, c3) {
                let seqStarted = false;
                const startSeq = () => {
                    if (seqStarted) return;
                    seqStarted = true;
                    playOne(c1, () =>
                        playOne(c2, () =>
                            playOne(c3, () => {
                                sequenceDone = true;
                            })
                        )
                    );
                };

                const file = idx === 0 ? instrFirst(mediaCity) : instrNext(mediaCity);
                currentInstr = playAudioAuto(
                    file,
                    { promptId: "pcInstrPrompt", promptText: "▶ Play instruction" },
                    startSeq
                );

                // Failsafe: if instruction never fires, kick off sequence after 15s
                setTimeout(startSeq, 15000);
            }

            function renderTrial() {
                const T = TRIALS[idx];
                renderSeqBar();
                trialCounter.textContent = `Trial ${idx + 1} of ${TRIALS.length}`;
                feedback.textContent = "";
                submitBtn.disabled = true;
                nextBtn.disabled = true;
                selected = null;
                sequenceDone = false;
                grid.innerHTML = "";

                const [u1, u2, u3] = T.assets; // full mp4 paths from JSON
                const c1 = buildChoice(1, u1);
                const c2 = buildChoice(2, u2);
                const c3 = buildChoice(3, u3);
                grid.append(c1.card, c2.card, c3.card);
                setDisabled(c1.card);
                setDisabled(c2.card);
                setDisabled(c3.card);

                startInstructionThenSequence(T.mediaCity, c1, c2, c3);
            }

            // Practice-only feedback (text + optional audio)
            function playPracticeFeedbackAudio(isCorrect, correctOption, mediaCity) {
                const file = isCorrect ? "correct.mp3" : `pc_incorrect${correctOption}.mp3`;
                const url = `media/${mediaCity}/audio/${lang}/feedback/${file}`;
                const a = new Audio(url);
                a.preload = "auto";
                a.muted = !audioUnlocked;
                a.volume = 1;
                a.play().catch(() => {});
            }

            submitBtn.addEventListener("click", () => {
                if (!sequenceDone || selected == null) return;
                const T = TRIALS[idx];
                const isCorrect = selected === Number(T.correct);

                if (isPractice) {
                    feedback.textContent = isCorrect ? "✅ Correct!" : `❌ Incorrect. It was Option ${T.correct}.`;
                    playPracticeFeedbackAudio(isCorrect, T.correct, T.mediaCity);
                } else {
                    feedback.textContent = ""; // no feedback outside practice
                }

                submitBtn.disabled = true;
                nextBtn.disabled = false;

                const dots = seqbar.querySelectorAll(".seq-dot");
                if (dots[idx]) dots[idx].classList.add("done");
            });

            nextBtn.addEventListener("click", () => {
                idx += 1;
                if (idx >= TRIALS.length) {
                    location.assign(nextURL);
                } else {
                    renderTrial();
                }
            });

            // Load trials
            fetch(trialsURL, { cache: "no-cache" })
                .then((r) => r.json())
                .then((data) => {
                    TRIALS = Array.isArray(data) ? data : [];
                    if (!TRIALS.length) throw new Error("No trials");
                    // Guard: PC should be video/mp4 assets
                    if (TRIALS[0]?.assets?.[0]?.endsWith(".png")) {
                        console.warn("Loaded image assets—this looks like PS, not PC:", TRIALS[0]?.assets);
                    }
                    renderTrial();
                })
                .catch((err) => {
                    feedback.textContent = "Could not load trials.";
                    console.error(err);
                });

            // -------- Dev quick-jump (same as PS) --------
            if (qs.get("dev") === "1") {
                const box = document.createElement("div");
                box.style.cssText =
                    "position:fixed;right:12px;top:12px;background:#fff;padding:8px 10px;border:1px solid #ddd;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.1);z-index:9999;display:flex;gap:6px;align-items:center;font:14px/1.2 system-ui";
                const s = document.createElement("select");
                [0, 1, 2, 3].forEach((n) => {
                    const o = document.createElement("option");
                    o.value = n;
                    o.textContent = `Session ${n}`;
                    if ((qs.get("session") || "0") == String(n)) o.selected = true;
                    s.appendChild(o);
                });
                const go = document.createElement("button");
                go.textContent = "Go";
                go.className = "btn";
                go.onclick = () => {
                    const currentV = qs.get("v") || v;
                    const targetCity = parseInt(s.value, 10) === 0 ? "City0" : `City${parseInt(s.value, 10)}`;
                    location.search = `?session=${s.value}&city=${targetCity}&v=${currentV}`;
                };
                box.append("Dev:", s, go);
                document.body.appendChild(box);
            }
        </script>
    </body>
</html>
