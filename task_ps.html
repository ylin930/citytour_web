<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PS</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      [hidden] {
        display: none !important;
      }
      .choice-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(220px, 1fr));
        gap: 16px;
      }
      .choice {
        display: flex;
        flex-direction: column;
        border-radius: 14px;
        border: 2px solid transparent;
        background: #fff;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .choice img {
        width: 100%;
        height: 260px;
        object-fit: cover;
        display: block;
        background: #000;
      }
      .label {
        text-align: center;
        padding: 10px 8px;
        font-weight: 600;
      }
      .choice.selected {
        border-color: #2563eb;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
      }
      /* placeholder skeleton while instruction plays */

      }
    </style>
  </head>
  <body data-task="ps">
    <main class="container">
      <header class="header">
        <div>
          <div class="badge" id="badge">PS</div>
          <div class="h1">Which place did you visit on your tour?</div>
          <div class="sub">Listen to the instruction, then choose one.</div>
        </div>
      </header>

      <section class="grid">
        <div class="card" style="display: flex; flex-direction: column; gap: 14px">
          <div id="trialCounter" class="muted">Trial 1</div>
          <div id="choices" class="choice-grid"></div>
          <div style="display: flex; justify-content: space-between; gap: 10px">
            <!--<button class="btn" type="button" onclick="history.back()">Back</button>-->
            <div style="display: flex; gap: 10px">
              <button id="submitBtn" class="btn primary" disabled>Submit</button>
              <button id="nextBtn" class="btn" disabled>Next</button>
            </div>
          </div>
          <div id="feedback" class="muted"></div>
        </div>
      </section>
    </main>

    <script type="module">
      /* ---------- Params / paths ---------- */
      const qs = new URLSearchParams(location.search);

      // normalize City and Session values (handles 0, 1, 2, etc)
      function canonCity(v) {
        const s = String(v ?? "City0").trim();
        const m = s.match(/(\d+)/);
        return `City${m ? parseInt(m[1], 10) : 0}`;
      }

      function canonSession(v) {
        const s = String(v ?? "0").trim();
        const m = s.match(/(\d+)/);
        return `${m ? parseInt(m[1], 10) : 0}`;
      }

      // page task type (from HTML body tag)
      const TASK = (document.body.dataset.task || "gen").toLowerCase();

      const session = canonSession(qs.get("session")); // → "0", "1", "2", "3"
      const city = canonCity(qs.get("city")); // → "City0", "City1", etc.
      const v = String(qs.get("v") || "1"); // version number
      const lang = (localStorage.getItem("ct_language") || "EN").toLowerCase();

      // build the proper config filename
      const trialsURL = qs.get("trials") || `config/trials_${session}_${city}_${TASK}_v${v}.json`;
      console.log("[trialsURL]", trialsURL);

      // where to go after finishing this block
      const nextURL = qs.get("next") || `session_video.html?session=${encodeURIComponent(session)}`;

      // file path helpers
      const instrFirst = (c) => `media/${c}/audio/${lang}/instructions/${TASK}_first.mp3`;
      const instrNext = (c) => `media/${c}/audio/${lang}/instructions/${TASK}_next.mp3`;
      const fbPath = (c, name) => `media/${c}/audio/${lang}/feedback/${name}`;
      const guideSrc = `media/${city}/images/guide.png`;
      //const animPath = (n) => `media/${city}/animations/${lang}/${n}.mp4`;

      // ---------- PS-specific instruction audio ----------
      const introAudio = `media/${city}/audio/${lang}/instructions/ps_intro.mp3`;
      const perTrialAudio = `media/${city}/audio/${lang}/instructions/ps.mp3`;

      // ---------- State / DOM ----------
      const grid = document.getElementById("choices");
      const trialCounter = document.getElementById("trialCounter");
      const submitBtn = document.getElementById("submitBtn");
      const nextBtn = document.getElementById("nextBtn");
      const feedback = document.getElementById("feedback");
      //const seqbar = document.getElementById("seqbar");
      document.getElementById("badge").textContent = `${TASK.toUpperCase()} • S${session}`;

      let TRIALS = [];
      let idx = 0,
        selected = null,
        sequenceDone = false;
      let audioUnlocked = false;
      let currentInstr = null,
        currentPlaying = null;

      function buildChoice(position, imgUrl) {
        const card = document.createElement("div");
        card.className = "choice";

        const img = document.createElement("img");
        img.src = imgUrl;
        img.alt = `Option ${position}`;
        img.onerror = () => {
          console.warn("Image failed to load:", imgUrl);
          img.style.objectFit = "contain";
          img.style.background = "#fee";
        };

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = `Option ${position}`;

        card.appendChild(img);
        card.appendChild(label);

        card.addEventListener("click", () => {
          document.querySelectorAll(".choice").forEach((el) => el.classList.remove("selected"));
          card.classList.add("selected");
          selected = position;
          submitBtn.disabled = false;
        });

        return card;
      }

      function playAudioOnce(url, onEnd) {
        const a = new Audio(url);
        a.preload = "auto";
        a.muted = false;
        a.volume = 1;

        a.addEventListener(
          "play",
          () => {
            const prompt = document.getElementById("instrPrompt");
            if (prompt) prompt.remove();
          },
          { once: true }
        );

        a.addEventListener(
          "play",
          () => {
            audioUnlocked = true;
          },
          { once: true }
        );
        a.addEventListener("ended", () => onEnd && onEnd(), { once: true });
        a.addEventListener("error", () => onEnd && onEnd(), { once: true });
        a.play().catch(() => {
          // prompt
          const bar = document.createElement("div");
          bar.style.margin = "6px 0 8px";
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.type = "button";
          btn.textContent = "▶ Play instruction";
          btn.addEventListener(
            "click",
            () => {
              a.currentTime = 0;
              a.play()
                .then(() => {
                  bar.remove();
                })
                .catch(() => {
                  bar.remove();
                  onEnd && onEnd();
                });
            },
            { once: true }
          );
          //seqbar.parentNode.insertBefore(bar, seqbar.nextSibling);
          // replace the prompt insert with a safe anchor:
          const anchor = document.getElementById("trialCounter") || document.querySelector("header") || document.body;
          anchor.insertAdjacentElement("afterend", bar);

          bar.appendChild(btn);
        });
      }

      function renderTrial() {
        const T = TRIALS[idx];
        trialCounter.textContent = `Trial ${idx + 1} of ${TRIALS.length}`;
        feedback.textContent = "";
        submitBtn.disabled = true;
        nextBtn.disabled = true;
        selected = null;

        grid.innerHTML = "";
        const [i1, i2, i3] = T.assets;
        grid.append(buildChoice(1, i1), buildChoice(2, i2), buildChoice(3, i3));

        // You can still play the per-trial instruction; it won’t affect visibility
        playAudioOnce(perTrialAudio, () => {});
      }

      function playFeedbackAudio(task, city, lang, isCorrect, correctOption) {
        // Only for practice
        const isPractice = city === "City0" || String(session) === "0";
        if (!isPractice) return;

        // Build filename pattern:
        // correct  -> "correct.mp3"
        // incorrect-> "<task>_incorrect{correctOption}.mp3" e.g., ps_incorrect2.mp3
        const prefix = task.toLowerCase(); // "ps" | "pc" | "gen"
        const file = isCorrect ? "correct.mp3" : `${prefix}_incorrect${correctOption}.mp3`;
        const url = `media/${city}/audio/${lang}/feedback/${file}`;

        const a = new Audio(url);
        a.preload = "auto";
        a.muted = false;
        a.volume = 1;
        a.play().catch((err) => {
          console.warn("Feedback audio failed (ok to ignore):", url, err?.message);
        });
      }

      submitBtn.addEventListener("click", () => {
        if (selected == null) return;
        const T = TRIALS[idx];
        const isCorrect = selected === Number(T.correct);

        feedback.textContent = isCorrect ? "✅ Correct!" : `❌ Incorrect. It was Option ${T.correct}.`;
        submitBtn.disabled = true;
        nextBtn.disabled = false;

        // Play feedback audio (practice only)
        playFeedbackAudio(TASK, city, lang, isCorrect, T.correct);
      });

      nextBtn.addEventListener("click", () => {
        idx += 1;
        if (idx >= TRIALS.length) {
          location.assign(nextURL);
        } else {
          renderTrial();
        }
      });

      // boot: play intro once, then first trial
      fetch(trialsURL)
        .then((r) => r.json())
        .then((data) => {
          TRIALS = Array.isArray(data) ? data : [];
          if (!TRIALS.length) throw new Error("No trials");

          // hide trial counter during intro
          trialCounter.hidden = true;

          // ---- render guide during intro ----
          grid.innerHTML = "";
          grid.style.display = "flex";
          grid.style.flexDirection = "column";
          grid.style.justifyContent = "center";
          grid.style.alignItems = "center";
          grid.style.minHeight = "70vh";
          grid.style.background = "#fff"; // optional, keeps a clean area

          const guideImg = document.createElement("img");
          guideImg.src = guideSrc;
          guideImg.alt = "Guide";
          guideImg.style.width = "auto";
          guideImg.style.maxWidth = "65vw";
          guideImg.style.maxHeight = "70vh";
          guideImg.style.objectFit = "contain";
          guideImg.style.borderRadius = "18px";
          guideImg.style.boxShadow = "0 8px 24px rgba(0,0,0,.15)";
          guideImg.onerror = () => {
            guideImg.remove();
            const fallback = document.createElement("div");
            fallback.textContent = "Guide image missing";
            fallback.style.padding = "24px 32px";
            fallback.style.background = "#fff3f3";
            fallback.style.border = "1px solid #f5c2c7";
            fallback.style.borderRadius = "12px";
            grid.appendChild(fallback);
          };

          grid.appendChild(guideImg);

          // ---- play the *intro* audio with guide visible ----
          playAudioOnce(introAudio, () => {
            // reset grid back to normal after intro
            grid.style.display = ""; // reset to default grid
            grid.style.flexDirection = "";
            grid.style.justifyContent = "";
            grid.style.alignItems = "";
            grid.style.minHeight = "";
            grid.style.background = "";

            guideImg.remove();
            trialCounter.hidden = false;
            renderTrial();
          });
        })
        .catch((err) => {
          feedback.textContent = "Could not load trials.";
          console.error(err);
        });
    </script>

    <!--to jump to different sessions-->
    <script>
      if (new URLSearchParams(location.search).get("dev") === "1") {
        const box = document.createElement("div");
        box.style.cssText =
          "position:fixed;right:12px;top:12px;background:#fff;padding:8px 10px;border:1px solid #ddd;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.1);z-index:9999;display:flex;gap:6px;align-items:center;font:14px/1.2 system-ui";
        const qs = new URLSearchParams(location.search);
        const task = (document.body.dataset.task || "gen").toLowerCase();
        const city = qs.get("city") || "City1";
        const v = qs.get("v") || "1";
        const s = document.createElement("select");
        [0, 1, 2, 3].forEach((n) => {
          const o = document.createElement("option");
          o.value = n;
          o.textContent = `Session ${n}`;
          if ((qs.get("session") || "0") == String(n)) o.selected = true;
          s.appendChild(o);
        });
        const go = document.createElement("button");
        go.textContent = "Go";
        go.className = "btn";
        go.onclick = () => {
          location.search = `?session=${s.value}&city=${city}&v=${v}`;
        };
        box.append("Dev:", s, go);
        document.body.appendChild(box);
      }
    </script>
  </body>
</html>
