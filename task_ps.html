<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PS</title>
    <link rel="stylesheet" href="styles.css" />

  </head>
  <body data-task="ps">
    <main class="container">
      <header class="header">
        <div>
          <div class="badge" id="badge">PS</div>
          <div class="h1">Which place did you visit on your tour?</div>
          <div class="sub">Listen to the instruction, then choose one.</div>
        </div>
      </header>

      <section class="grid">
        <div class="card">
          <div id="trialCounter" class="muted">Trial 1</div>
          <div id="choices" class="choice-grid"></div>
          <div style="display: flex; justify-content: space-between; gap: 10px">
            <!--<button class="btn" type="button" onclick="history.back()">Back</button>-->
            <div style="display: flex; gap: 10px">
              <button id="submitBtn" class="btn primary" disabled>Submit</button>
              <button id="nextBtn" class="btn" disabled>Next</button>
            </div>
          </div>
          <div id="feedback" class="muted"></div>
        </div>
      </section>
    </main>

    <script type="module">
      /* ---------- Params / paths ---------- */
      const qs = new URLSearchParams(location.search);

      function canonCity(v) {
        const s = String(v ?? "City0").trim();
        const m = s.match(/(\d+)/);
        return `City${m ? parseInt(m[1], 10) : 0}`;
      }
      function canonSession(v) {
        const s = String(v ?? "0").trim();
        const m = s.match(/(\d+)/);
        return `${m ? parseInt(m[1], 10) : 0}`;
      }

      const TASK = (document.body.dataset.task || "ps").toLowerCase();

      const rawCity = qs.get("city");
      const session = (function canonSession(v) {
        const s = String(v ?? "0").trim();
        const m = s.match(/(\d+)/);
        return `${m ? parseInt(m[1], 10) : 0}`;
      })(qs.get("session"));

      const sessionNum = parseInt(session, 10) || 0;

      // Start from query or session→City{session}
      let city = rawCity
        ? (function canonCity(v) {
            const s = String(v ?? "City0").trim();
            const m = s.match(/(\d+)/);
            return `City${m ? parseInt(m[1], 10) : 0}`;
          })(rawCity)
        : `City${sessionNum}`;

      // If user passed City0 but we're in S1–S3, correct it.
      if (sessionNum > 0 && city === "City0") {
        city = `City${sessionNum}`;
      }

      const v = String(qs.get("v") || "1");
      const lang = (localStorage.getItem("ct_language") || "EN").toLowerCase();

      // config file
      const trialsURL = qs.get("trials") || `config/trials_${session}_${city}_${TASK}_v${v}.json`;
      // where to go after finishing this block
      const nextURL = qs.get("next") || `session_video.html?session=${encodeURIComponent(session)}`;

      // PS audio paths
      // PS audio paths (handle City0 legacy layout)
      const guideSrc = `media/${city}/images/guide.png`;
      const legacyCity0 = city === "City0"; // <-- City0 uses /instructions/ folder

      const introAudio = legacyCity0
        ? `media/${city}/audio/${lang}/instructions/ps_intro.mp3`
        : `media/${city}/audio/${lang}/ps_intro.mp3`;

      const perTrialAudio = legacyCity0
        ? `media/${city}/audio/${lang}/instructions/ps.mp3`
        : `media/${city}/audio/${lang}/ps.mp3`;

      // ---------- DOM ----------
      const grid = document.getElementById("choices");
      const trialCounter = document.getElementById("trialCounter");
      const submitBtn = document.getElementById("submitBtn");
      const nextBtn = document.getElementById("nextBtn");
      const feedback = document.getElementById("feedback");
      document.getElementById("badge").textContent = `PS • S${session}`;

      // ---------- State ----------
      let TRIALS = [];
      let idx = 0;
      let selected = null;

      const isPractice = sessionNum === 0 || city === "City0";

      // ---------- Helpers: one-time prompt for autoplay fallback ----------
      function ensurePrompt(id, text = "▶ Play audio") {
        let bar = document.getElementById(id);
        if (!bar) {
          bar = document.createElement("div");
          bar.id = id;
          bar.style.margin = "8px 0 12px";
          bar.innerHTML = `<button class="btn" type="button">${text}</button>`;
          const anchor = document.getElementById("trialCounter") || document.querySelector("header") || document.body;
          anchor.insertAdjacentElement("afterend", bar);
        }
        return bar.querySelector("button");
      }
      function removePrompt(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      function playPracticeFeedbackAudio(isCorrect, correctOption) {
        // correct -> feedback/correct.mp3
        // wrong   -> feedback/ps_incorrect{n}.mp3
        const file = isCorrect ? "correct.mp3" : `ps_incorrect${correctOption}.mp3`;
        const url = `media/${city}/audio/${lang}/feedback/${file}`;
        const a = new Audio(url);
        a.preload = "auto";
        a.muted = false;
        a.volume = 1;
        a.play().catch(() => {
          /* ok to fail silently */
        });
      }

      // play an audio with graceful fallback prompt
      function playAudioAuto(url, { promptId, promptText = "▶ Play instruction" } = {}, onEnd) {
        removePrompt(promptId);

        const a = new Audio(url);
        a.preload = "auto";
        a.muted = false;
        a.volume = 1;

        let played = false;
        let cleaned = false;

        const cleanup = () => {
          if (cleaned) return;
          cleaned = true;
          removePrompt(promptId);
          document.removeEventListener("click", clickOnce, { capture: true });
        };

        const clickOnce = () => {
          a.currentTime = 0;
          a.play()
            .then(() => cleanup())
            .catch(() => {
              /* ignore */
            });
        };

        a.addEventListener(
          "play",
          () => {
            played = true;
            cleanup();
          },
          { once: true }
        );

        a.addEventListener(
          "ended",
          () => {
            cleanup();
            onEnd && onEnd();
          },
          { once: true }
        );
        a.addEventListener(
          "error",
          () => {
            cleanup();
            onEnd && onEnd();
          },
          { once: true }
        );

        // Try autoplay
        a.play().catch(() => {
          /* some browsers reject, others fail silently */
        });

        // If no 'play' fired quickly, show prompt and also listen for first page tap
        setTimeout(() => {
          if (played) return;
          const btn = ensurePrompt(promptId, promptText);
          btn.onclick = () => {
            a.currentTime = 0;
            a.play()
              .then(() => cleanup())
              .catch(() => {
                cleanup();
                onEnd && onEnd();
              });
          };
          document.addEventListener("click", clickOnce, { once: true, capture: true });
        }, 700);

        return a;
      }

      // Center the guide image in the grid area
      function showGuideCentered() {
        grid.style.display = "flex";
        grid.style.justifyContent = "center";
        grid.style.alignItems = "center";
        grid.style.minHeight = "60vh";
        grid.style.background = "transparent";
        grid.innerHTML = "";

        const img = document.createElement("img");
        img.src = guideSrc;
        img.alt = "Guide";
        img.style.maxWidth = "520px";
        img.style.width = "60%";
        img.style.borderRadius = "18px";
        img.style.boxShadow = "0 8px 24px rgba(0,0,0,.12)";
        grid.appendChild(img);

        return () => {
          grid.innerHTML = "";
          // reset grid layout so choices use CSS grid again
          grid.style.display = "";
          grid.style.justifyContent = "";
          grid.style.alignItems = "";
          grid.style.minHeight = "";
          grid.style.background = "";
        };
      }

      // ---------- UI builders ----------
      function buildChoice(position, imgUrl) {
        const card = document.createElement("div");
        card.className = "choice";

        const wrap = document.createElement("div");
        wrap.className = "img-wrap";

        const img = document.createElement("img");
        img.src = imgUrl;
        img.onerror = () => {
          wrap.style.background = "#fee";
          img.style.objectFit = "contain";
        };

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = `Option ${position}`;

        wrap.appendChild(img);
        card.append(wrap, label);

        card.addEventListener("click", () => {
          document.querySelectorAll(".choice").forEach((el) => el.classList.remove("selected"));
          card.classList.add("selected");
          selected = position;
          submitBtn.disabled = false;
        });

        return card;
      }

      function renderTrial() {
        const T = TRIALS[idx];

        trialCounter.hidden = false;
        trialCounter.textContent = `Trial ${idx + 1} of ${TRIALS.length}`;
        feedback.textContent = "";
        submitBtn.disabled = true;
        nextBtn.disabled = true;
        selected = null;

        grid.innerHTML = "";
        const [i1, i2, i3] = T.assets;
        grid.append(buildChoice(1, i1), buildChoice(2, i2), buildChoice(3, i3));

        // per-trial instruction (options already visible)
        playAudioAuto(perTrialAudio, { promptId: "trialPrompt", promptText: "▶ Play instruction" }, () => {
          /* nothing else to do */
        });
      }

      // practice-only feedback text (no audio for now)
      submitBtn.addEventListener("click", () => {
        if (selected == null) return;
        const T = TRIALS[idx];
        const isCorrect = selected === Number(T.correct);

        if (isPractice) {
          feedback.textContent = isCorrect ? "✅ Correct!" : `❌ Incorrect. It was Option ${T.correct}.`;
          playPracticeFeedbackAudio(isCorrect, T.correct); // <- audio feedback (City0 only)
        } else {
          feedback.textContent = ""; // no feedback for sessions 1–3
        }

        submitBtn.disabled = true;
        nextBtn.disabled = false;
      });

      nextBtn.addEventListener("click", () => {
        idx += 1;
        if (idx >= TRIALS.length) {
          location.assign(nextURL);
        } else {
          renderTrial();
        }
      });

      // ---------- Boot: load trials, show guide, play intro, then render first trial ----------
      async function loadTrialsJSON() {
        const task = (document.body.dataset.task || "ps").toLowerCase();
        const v = String(new URLSearchParams(location.search).get("v") || "1");
        const s = session; // from your existing code
        const c = city; // from the safer default above

        console.log("[PS boot]", { session, city, v, task: TASK });

        const candidates = [
          `config/trials_${s}_${c}_${task}_v${v}.json`,
          // If city wasn’t explicitly set, try mapping session->City{session}
          `config/trials_${s}_City${parseInt(s, 10) || 0}_${task}_v${v}.json`,
          // Last resort: City1
          `config/trials_${s}_City1_${task}_v${v}.json`
        ];

        for (const url of candidates) {
          try {
            const res = await fetch(url, { cache: "no-cache" });
            if (res.ok) {
              console.log("[trialsURL]", url);
              return await res.json();
            }
          } catch {}
        }
        throw new Error("No trials JSON found.");
      }

      loadTrialsJSON()
        .then((data) => {
          TRIALS = Array.isArray(data) ? data : [];
          if (!TRIALS.length) throw new Error("No trials");

          // Hide the counter during the intro
          trialCounter.hidden = true;

          // Show the guide while the *intro* audio plays
          const cleanupGuide = showGuideCentered();

          // Try to autoplay; if blocked, a single prompt appears ("▶ Play introduction")
          playAudioAuto(introAudio, { promptId: "introPrompt", promptText: "▶ Play introduction" }, () => {
            // After intro ends (or user taps), remove guide and render trial 1
            cleanupGuide();
            renderTrial();
          });
        })
        .catch((err) => {
          feedback.textContent = "Could not load trials.";
          console.error(err);
        });

      // ---------- Dev quick-jump (optional) ----------
      if (qs.get("dev") === "1") {
        const box = document.createElement("div");
        box.style.cssText =
          "position:fixed;right:12px;top:12px;background:#fff;padding:8px 10px;border:1px solid #ddd;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.1);z-index:9999;display:flex;gap:6px;align-items:center;font:14px/1.2 system-ui";
        const s = document.createElement("select");
        [0, 1, 2, 3].forEach((n) => {
          const o = document.createElement("option");
          o.value = n;
          o.textContent = `Session ${n}`;
          if ((qs.get("session") || "0") == String(n)) o.selected = true;
          s.appendChild(o);
        });
        const go = document.createElement("button");
        go.textContent = "Go";
        go.className = "btn";
        const currentCity = qs.get("city") || city;
        const currentV = qs.get("v") || v;
        go.onclick = () => (location.search = `?session=${s.value}&city=${currentCity}&v=${currentV}`);
        box.append("Dev:", s, go);
        document.body.appendChild(box);
      }
    </script>
  </body>
</html>
