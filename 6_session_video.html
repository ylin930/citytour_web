<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>City Tour – Session Intro</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="styles.css" />
        <!-- Optional: prefetch likely video to warm cache -->
        <!-- <link rel="prefetch" href="/media/cover/intro_S1_EN.mp4" as="video" type="video/mp4" /> -->

        <style>
            .video-wrap {
                position: relative;
                max-width: 600px;
                margin: 0 auto;
                border-radius: 16px;
                overflow: hidden;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                background: #000;
            }
            video {
                display: block;
                width: 100%;
                height: auto;
                background: #000;
            }
            .overlay,
            .loading {
                position: absolute;
                inset: 0;
                display: grid;
                place-items: center;
                background: rgba(0, 0, 0, 0.35);
                color: #fff;
                font-weight: 600;
            }
            .hidden {
                display: none;
            }
            .pill {
                background: #fff;
                color: #111;
                border-radius: 999px;
                padding: 10px 14px;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
                cursor: pointer;
                user-select: none;
            }
            #nextBtn[disabled] {
                opacity: 0.5;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <main class="container">
            <header class="header">
                <div>
                    <div class="badge" id="badge">CITY TOUR • SESSION <span id="sessionNumber">1</span></div>
                    <div class="h1" id="title">Session <span id="sessionNumberTitle">1</span></div>
                    <div class="sub" id="subtitle">Please watch the short video. "Next" unlocks when it ends.</div>
                </div>
            </header>

            <section class="grid">
                <div class="card" style="display: flex; flex-direction: column; gap: 14px; align-items: center">
                    <div class="video-wrap">
                        <video
                            id="introVideo"
                            autoplay
                            playsinline
                            preload="auto"
                            poster="media/cover/CT_cover.png"
                            controlslist="nodownload noplaybackrate nofullscreen"
                            disablepictureinpicture>
                            <source id="introSrc" type="video/mp4" />
                        </video>

                        <div id="loading" class="loading">Loading video…</div>

                        <div id="overlay" class="overlay hidden"><div class="pill">Play</div></div>
                    </div>

                    <div class="buttons" style="justify-content: flex-end; width: 100%">
                        <button id="nextBtn" class="btn primary" type="button" disabled>Next</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Firebase config -->
        <script src="js/firebase-config.js"></script>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
            import {
                getStorage,
                ref,
                getDownloadURL
            } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

            // ---------- DOM refs
            const video = document.getElementById("introVideo");
            const srcEl = document.getElementById("introSrc");
            const loading = document.getElementById("loading");
            const overlay = document.getElementById("overlay");
            const nextBtn = document.getElementById("nextBtn");
            const badgeEl = document.getElementById("badge");
            const titleEl = document.getElementById("title");
            const sessionNumberEl = document.getElementById("sessionNumber");
            const sessionNumberTitleEl = document.getElementById("sessionNumberTitle");

            // ---------- Get language and session from URL parameters or localStorage
            const lang = (localStorage.getItem("ct.lang") || localStorage.getItem("ct_language") || "EN").toUpperCase();
            const qs = new URLSearchParams(location.search);
            let session = parseInt(qs.get("session") || localStorage.getItem("ct.session") || "1");
            
            // If no session in URL or localStorage, default to 1
            if (!qs.get("session") && !localStorage.getItem("ct.session")) {
                session = 1;
                localStorage.setItem("ct.session", "1");
            }
            
            console.log("Session video - lang:", lang, "session:", session, "from URL:", qs.get("session"));

            // ---------- Update UI with session number
            function updateUI() {
                if (sessionNumberEl) {
                    sessionNumberEl.textContent = session;
                }
                if (sessionNumberTitleEl) {
                    sessionNumberTitleEl.textContent = session;
                }
                
                // Update title based on session
                if (titleEl) {
                    if (session === 1) {
                        titleEl.textContent = "Welcome to City Tour";
                    } else {
                        titleEl.textContent = `Session ${session} - Continue`;
                    }
                }
            }

            // Update UI immediately if DOM is ready, otherwise wait
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateUI);
            } else {
                updateUI();
            }

            // ---------- Map session → video paths
            const VIDEO_MAP = {
                1: {
                    storage: `media/cover/CT_cover_${lang}.mp4`,
                    hosting: `media/cover/CT_cover_${lang}.mp4`,
                    poster: `media/cover/CT_cover.png`
                },
                2: {
                    storage: `media/cover/continue_${lang}.mp4`,
                    hosting: `media/cover/continue_${lang}.mp4`
                },
                3: {
                    storage: `media/cover/continue_${lang}.mp4`,
                    hosting: `media/cover/continue_${lang}.mp4`
                }
            };

            // ---------- Safe async boot (no top-level await)
            (async () => {
                try {
                    // Firebase is optional; if missing, we fall back to hosting
                    let storage = null;
                    try {
                        const app = initializeApp(window.FB_CONFIG);
                        storage = getStorage(app);
                    } catch (e) {
                        // FB_CONFIG not defined or Firebase blocked — that's fine
                    }

                    async function getMediaURL(storagePath, hostingPath, timeoutMs = 2500) {
                        if (!storage) return hostingPath;
                        try {
                            const p = getDownloadURL(ref(storage, storagePath));
                            const t = new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), timeoutMs));
                            return await Promise.race([p, t]);
                        } catch {
                            return hostingPath;
                        }
                    }

                    const choice = VIDEO_MAP[session] || VIDEO_MAP[1];
                    console.log("Session video - selected video choice:", choice);
                    
                    if (choice.poster) video.setAttribute("poster", choice.poster);

                    // Load source with robust fallback
                    const url = await getMediaURL(choice.storage, choice.hosting);
                    console.log("Session video - loading video URL:", url);
                    srcEl.src = url;
                    video.load();

                    // Loading & autoplay behavior
                    video.addEventListener("canplay", () => loading.classList.add("hidden"));

                    try {
                        await video.play();
                    } catch {
                        overlay.classList.remove("hidden");
                    }

                    overlay.addEventListener("click", async () => {
                        overlay.classList.add("hidden");
                        try {
                            await video.play();
                        } catch {}
                    });


                    // Enable Next when the video ends (normal mode)
                    video.addEventListener("ended", () => {
                        nextBtn.disabled = false;
                        nextBtn.classList.remove("opacity-50", "pointer-events-none");
                    });

                    // Handle Next button click
                    nextBtn.addEventListener("click", () => {
                        console.log("Session video - current session:", session);
                        
                        // Route to next page based on current session
                        if (session === 1) {
                            // Session 1: Cover story → Practice (City0) → Practice tasks → City 1 tasks
                            console.log("Session 1 - routing to practice intro");
                            window.location.href = "practice_intro.html";
                        } else if (session === 2) {
                            // Session 2: Continue video → City 2 tasks
                            console.log("Session 2 - routing to City 2 tasks");
                            window.location.href = "task_gen.html?session=2&city=City2";
                        } else if (session === 3) {
                            // Session 3: Continue video → City 3 tasks
                            console.log("Session 3 - routing to City 3 tasks");
                            window.location.href = "task_gen.html?session=3&city=City3";
                        } else {
                            // Fallback or completed all sessions
                            console.log("All sessions completed or unknown session");
                            window.location.href = "1_index.html";
                        }
                    });

                } catch (err) {
                    // Last-resort: don't strand the user — enable Next
                    nextBtn.disabled = false;
                }
            })();

            // Dev tools support
            window.CT_NEXT = () => {
                if (session === 1) {
                    return "practice_intro.html";
                } else if (session === 2) {
                    return "task_gen.html?session=2&city=City2";
                } else if (session === 3) {
                    return "task_gen.html?session=3&city=City3";
                } else {
                    return "1_index.html";
                }
            };

            // Add session navigation shortcuts for dev tools
            document.addEventListener('keydown', (e) => {
                const qs = new URLSearchParams(location.search);
                if (qs.get("dev") === "1") {
                    // Number keys 1, 2, 3 to jump to specific sessions
                    if (e.key === "1") {
                        e.preventDefault();
                        window.location.href = "6_session_video.html?session=1&dev=1";
                    } else if (e.key === "2") {
                        e.preventDefault();
                        window.location.href = "6_session_video.html?session=2&dev=1";
                    } else if (e.key === "3") {
                        e.preventDefault();
                        window.location.href = "6_session_video.html?session=3&dev=1";
                    }
                    // Show extended help for session navigation
                    else if (e.key === "h") {
                        e.preventDefault();
                        // Create a toast message with session navigation help
                        const el = document.createElement("div");
                        el.textContent = "Session nav: 1=Session1, 2=Session2, 3=Session3";
                        el.style.cssText = "position:fixed;bottom:12px;right:12px;z-index:99999;padding:10px 14px;background:#111;color:#fff;border-radius:10px;font:600 13px/1.2 system-ui;opacity:0.95;transition:opacity .3s";
                        document.body.appendChild(el);
                        setTimeout(() => { el.style.opacity = "0"; setTimeout(() => el.remove(), 300); }, 2000);
                    }
                }
            });
        </script>
        <script src="js/dev-tools.js"></script>
    </body>
</html>
