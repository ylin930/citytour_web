<!doctype html>
<html lang="en">
    <head>
    <meta name="ct-next" content="demographics_audio.html">
        <meta charset="utf-8" />
        <title>City Tour – Instructions</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="styles.css" />
    </head>

    <body>
        <main class="container">
            <header class="header">
                <div>
                    <div class="badge" id="badge">CITY TOUR • INSTRUCTIONS</div>
                    <div class="h1" id="title">Instructions</div>
                    <div class="sub" id="subtitle"></div>
                </div>
            </header>

            <section class="grid">
                <!-- Dynamically loaded instruction content -->
                <div class="card">
                    <div id="instructionText" style="max-height: 40vh; overflow-y: auto; padding-right: 6px">
                        <p style="opacity: 0.7">Loading instructions…</p>
                    </div>
                </div>
                <div id="scrollHint" class="sub" style="text-align: center; color: #666">
                    ▼ Continue to scroll to read the full instruction
                </div>

                <!-- Divider line -->
                <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;" />

                <!-- Simple acknowledgment -->
                <div style="margin: 20px 0;">
                    <label class="checkbox" style="margin-top: 1px">
                        <input type="checkbox" id="ack" />
                        <span id="ackLabel">I have read and understand the instructions.</span>
                    </label>

                    <div id="instrError" class="hint" style="margin-top: 8px"></div>
                </div>

                <div class="progress" style="margin: 30px 0 20px 0;"><span style="width: 30%"></span></div>

                <div class="buttons" style="justify-content: space-between; margin: 20px 0;">
                    <button class="btn" onclick="goBack()">Back</button>
                    <button id="continue" class="btn primary" disabled>Continue</button>
                </div>
            </section>
        </main>

        <script>
            // Safe Back
            function goBack() {
                if (document.referrer && document.referrer !== window.location.href) history.back();
                else location.href = "3_id_check.html";
            }

            //// Read choices
            //const lang = localStorage.getItem("ct_language") || "EN";
            //const country = localStorage.getItem("ct_country") || "US";
            //const role = localStorage.getItem("ct_role") || "adult";
            // Read choices  ✅ prefer new keys; fallback to old keys
            const lang = (localStorage.getItem("ct.lang") || localStorage.getItem("ct_language") || "EN").toUpperCase(); // "EN"/"GER"
            const role = (localStorage.getItem("ct.group") || localStorage.getItem("ct_role") || "adult").toLowerCase(); // "adult"/"child"

            // Debug logging
            console.log("Instructions page - localStorage values:");
            console.log("ct.lang:", localStorage.getItem("ct.lang"));
            console.log("ct_language:", localStorage.getItem("ct_language"));
            console.log("ct.group:", localStorage.getItem("ct.group"));
            console.log("ct_role:", localStorage.getItem("ct_role"));
            console.log("Final lang:", lang);
            console.log("Final role:", role);

            // Country is derived from language ONLY (requirement: EN→US, GER→DE)
            const country = lang === "GER" ? "DE" : "US";

            // UI strings
            const UI = {
                EN: {
                    badge: "CITY TOUR • INSTRUCTIONS",
                    title: "Instructions",
                    subtitle: "Please read the instructions carefully before starting.",
                    ack: "I have read and understand the instructions.",
                    continue: "Continue"
                },
                GER: {
                    badge: "CITY TOUR • ANLEITUNG",
                    title: "Anleitung",
                    subtitle: "Bitte lesen Sie die folgenden Anweisungen sorgfältig, bevor Sie beginnen.",
                    ack: "Ich habe die Anleitung gelesen und verstanden.",
                    continue: "Weiter"
                }
            };
            const t = UI[lang] || UI.EN;
            const el = (id) => document.getElementById(id);
            el("badge").textContent = t.badge;
            el("title").textContent = t.title;
            el("subtitle").textContent = t.subtitle;
            el("ackLabel").textContent = t.ack;
            el("continue").textContent = t.continue;

            // Load instruction HTML (depends ONLY on language + role; country is derived above)
            const key = `${country}_${role}_${lang}`; // e.g., US_child_EN or DE_adult_GER
            const filePath = `instructions/instructions_${key}.html`;
            
            console.log("Instructions file path:", filePath);
            console.log("Constructed key:", key);

            fetch(filePath, { cache: "no-store" })
                .then((r) => {
                    if (!r.ok) throw new Error(filePath + " not found");
                    return r.text();
                })
                .then((html) => {
                    el("instructionText").innerHTML = html;
                    // Re-check scroll requirements after content loads
                    setTimeout(checkScrollRequirement, 50);
                })
                .catch((err) => {
                    el("instructionText").innerHTML =
                        `<p style="color:#b00020">⚠️ Instructions not found for <code>${key}</code>.</p>`;
                    console.error(err);
                });

            // ---- Scroll-to-end gate + error messaging ----
            const instrBox = document.getElementById("instructionText"); // ✅ matches HTML
            const ack = document.getElementById("ack"); // ✅ matches HTML
            const continueBtn = document.getElementById("continue");
            const scrollHint = document.getElementById("scrollHint");
            const instrError = document.getElementById("instrError");

            function showInstrError(msg) {
                if (!instrError) return;
                instrError.textContent = msg;
                instrError.style.color = "#b00020";
            }
            function clearInstrError() {
                if (instrError) instrError.textContent = "";
            }

            // Check if scrolling is needed
            function checkScrollRequirement() {
                const needsScroll = instrBox.scrollHeight > instrBox.clientHeight;
                console.log("Scroll needed:", needsScroll, "scrollHeight:", instrBox.scrollHeight, "clientHeight:", instrBox.clientHeight);
                
                if (!needsScroll) {
                    // No scrolling needed, enable checkbox immediately
                    ack.disabled = false;
                    if (scrollHint) scrollHint.style.display = "none";
                    clearInstrError();
                } else {
                    // Scrolling needed, show hint and require scroll
                    ack.disabled = true;
                    if (scrollHint) scrollHint.style.display = "block";
                }
            }

            // lock initially
            ack.disabled = true;
            continueBtn.disabled = true;

            // Check scroll requirement after content loads
            setTimeout(checkScrollRequirement, 100);

            // unlock after scrolling to bottom (only if scrolling is needed)
            instrBox.addEventListener("scroll", () => {
                const atBottom = instrBox.scrollTop + instrBox.clientHeight >= instrBox.scrollHeight - 10;
                if (atBottom) {
                    ack.disabled = false;
                    if (scrollHint) scrollHint.style.display = "none";
                    clearInstrError();
                }
            });

            // Explain if they try to click early (capture on the checkbox area)
            const ackArea = document.querySelector("label.checkbox").parentElement; // the div that contains the checkbox
            ackArea.addEventListener(
                "pointerdown",
                (e) => {
                    if (ack.disabled) {
                        e.preventDefault();
                        const needsScroll = instrBox.scrollHeight > instrBox.clientHeight;
                        if (needsScroll) {
                            showInstrError("Please scroll to the end before checking \"I have read the instructions\".");
                        } else {
                            showInstrError("Please wait for the page to load completely.");
                        }
                        instrBox.focus({ preventScroll: false });
                    }
                },
                true
            );

            // When acknowledged, enable Continue
            ack.addEventListener("change", () => {
                clearInstrError();
                continueBtn.disabled = !ack.checked;
            });

            // Guard Continue click
            continueBtn.addEventListener("click", (e) => {
                if (!ack.checked) {
                    e.preventDefault();
                    showInstrError("Please check “I have read the instructions” to continue.");
                    return;
                }
                localStorage.setItem("ct_instructionsAck", "yes");
                location.href = "5_demographics_audio.html";
            });
        </script>
      <script src="js/dev-tools.js"></script>
</body>
</html>